#!/usr/bin/env bash

set -e

KEY_FILE="/var/lib/scylla-manager/scylla_manager.key"
CRT_FILE="/var/lib/scylla-manager/scylla_manager.crt"
SUBJECT="/C=US/ST=Scylla/L=Scylla/O=Scylla/OU=Scylla/CN=scylla.com"

print_usage() {
    echo "scyllamgr_ssl_cert_gen --subject <the_subject>"
    echo "  -s --subject				specify certificate info, default=\"${SUBJECT}\""
    echo "  -h --help	    			display help info"
}

while [ $# -gt 0 ]; do
    case "$1" in
        "-s"|"--subject")
            SUBJECT="$2"
            shift 2
            ;;
        "-h" | "--help")
            print_usage
            exit 0
            ;;
        *)
            break
    esac
done

if [ "`id -u`" -ne 0 ]; then
    echo "Requires root permission."
    exit 1
fi

if [ -f ${KEY_FILE} ]; then
    echo "key '$KEY_FILE' exists, to regenerate please delete it as well as the certificate '$CRT_FILE'"
    exit 1
fi

if [ -f ${CRT_FILE} ]; then
    echo "certificate '$CRT_FILE' exists, to regenerate please delete it as well as the key '$KEY_FILE'"
    exit 1
fi

openssl genrsa -out ${KEY_FILE} 4096
openssl req -new -x509 -sha512 -subj="${SUBJECT}" -key ${KEY_FILE} -out ${CRT_FILE} -days 365
chown scylla-manager:scylla-manager ${KEY_FILE}
chown scylla-manager:scylla-manager ${CRT_FILE}
